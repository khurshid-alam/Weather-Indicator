#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# main.py
# Copyright (C) Sebastian MacDonald 2010 <sebas310@gmail.com>
# 
# weather-indicator is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# weather-indicator is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License along
# with this program.  If not, see <http://www.gnu.org/licenses/>.


import pygtk
pygtk.require('2.0')
import gtk
import gobject
import appindicator
import gconf
import os
import urllib2
import time
from threading import Timer
import thread
import locale

class weather_indicator:
    def __init__(self):
        self.winder = appindicator.Indicator ("weather-indicator", "stock_weather-cloudy", appindicator.CATEGORY_APPLICATION_STATUS)
        self.winder.set_status (appindicator.STATUS_ACTIVE)
        self.winder.set_attention_icon ("ubuntuone-client-error")
        
        self.gconfClient = gconf.client_get_default()
        
        first_run = self.gconfClient.get_bool("/apps/weather-indicator/first_run")
        self.rate = self.gconfClient.get_int("/apps/weather-indicator/refresh_rate")
        self.unit = self.gconfClient.get_string("/apps/weather-indicator/unit")
        self.placechosen = self.gconfClient.get_int("/apps/weather-indicator/placechosen")
        
        if self.placechosen in (False, None):
            self.placechosen = 0
        
        if self.unit in (False, None):
            self.gconfClient.set_string("/apps/weather-indicator/unit", 'F')
            self.unit = 'F'
            
        if self.rate in (False, None):
            self.gconfClient.set_int("/apps/weather-indicator/refresh_rate", 5)
            self.rate = self.rate = self.gconfClient.get_int("/apps/weather-indicator/refresh_rate")
        
        self.menu = gtk.Menu()

        '''self.city_show = gtk.MenuItem()
        self.city_table = gtk.Table(1, 2, True)
        self.city_show.add(self.city_table)
        city_adder = gtk.Label("City")
        self.city_table.attach(city_adder, 0, 1, 0, 1)
        city_adder.show()
        self.city_show.show_all()
        self.menu.append(self.city_show)'''
        
    ##City
        self.city_show = gtk.MenuItem()
        self.city_show.show()
        self.menu.append(self.city_show)
        
    ##Condition
        self.cond_show = gtk.MenuItem()
        self.cond_show.show()
        self.menu.append(self.cond_show)
        
    ##Temperature        
        self.temp_show = gtk.MenuItem()
        self.temp_show.show()
        self.menu.append(self.temp_show)
        
    ##Humidity
        self.humid_show = gtk.MenuItem()
        self.humid_show.show()
        self.menu.append(self.humid_show)
        
    ##Wind
        self.wind_show = gtk.MenuItem()
        self.wind_show.show()
        self.menu.append(self.wind_show)
                
    ##If this is the first run : newlocation, then update the menu elements above.
        if first_run in (False, None):
            self.firsty()
        
        self.places = eval(self.gconfClient.get_string("/apps/weather-indicator/places"))
        print 'Location(s) :',self.places        
            
    ##Breaker
        breaker = gtk.SeparatorMenuItem()
        breaker.show()
        self.menu.append(breaker)
        
    ##Cities
        for place in self.places:
            loco = gtk.RadioMenuItem(None, place)
            loco.show()
            self.menu.append(loco)
        
    ##Breaker
        breaker = gtk.SeparatorMenuItem()
        breaker.show()
        self.menu.append(breaker)
        
    ##Change City
        replace = gtk.MenuItem("Change City")
        replace.connect("activate", self.replacer)
        replace.show()
        self.menu.append(replace)

    #Add City
        add = gtk.MenuItem("Add City")
        add.connect("activate", self.adder)
        add.show()
        self.menu.append(add)

    ##Breaker
        breaker = gtk.SeparatorMenuItem()
        breaker.show()
        self.menu.append(breaker)
        
    ##Preferences      
        prefs_show = gtk.MenuItem("Preferences")
        prefs_show.connect("activate", self.prefs)
        prefs_show.show()
        self.menu.append(prefs_show)
        
        self.place = self.places[self.placechosen]
        self.update_weather()
        self.menu.show()
        self.winder.set_menu(self.menu)

    def update_weather(self, widget=None):
        current = self.get_weather(self.places[self.placechosen])
        
        self.condition = current
        
        print 'Update :',current,'(every',self.rate,'min.)'
        
        current = self.icon
        
        if current in ('chance_of_storm', 'storm', 'thunderstorm', 'chance_of_tstorm'):
            self.storms()
        elif current in ('sleet',  'snow',  'icy',  'flurries',  'chance_of_snow'):
            self.snow()
        elif current in ('dust',  'fog',  'smoke',  'haze',  'mist'):
            self.fog()
        elif current in ('chance_of_rain',  'rain'):
            self.showers()
        elif current in ('sunny', 'clear'):
            self.clear()
        elif current in ('mostly_cloudy', 'cloudy'):
            self.cloudy()
        elif current in ('mostly_sunny',  'partly_cloudy'):
            self.few_clouds()
        else:
            self.err()
        #self.city_table.attach(gtk.Label("City"), 0, 1, 0, 1)
        
        self.city_show.set_label(self.city)
        self.cond_show.set_label(self.condition)
        self.temp_show.set_label(self.temp)
        self.humid_show.set_label(self.humid)
        self.wind_show.set_label(self.wind)
        
        self.rateid = gobject.timeout_add(int(self.rate) * 60000, self.update_weather)
                            
    def showers(self):
        self.winder.set_icon("stock_weather-showers")
        
    def storms(self):
        self.winder.set_icon("stock_weather-storm")
        
    def cloudy(self):
        self.winder.set_icon("stock_weather-cloudy")
        
    def few_clouds(self):
        self.winder.set_icon("weather-few-clouds")
    
    def fog(self):
        self.winder.set_icon("stock_weather-fog")    
        
    def clear(self):
        self.winder.set_icon("stock_weather-sunny")
        
    def snow(self):
        self.winder.set_icon("stock_weather-snow")
        
    def severe(self):
        self.winder.set_icon("weather-severe-alert")
    
    def err(self):
        self.winder.set_icon("ubuntuone-client-error")
    
    def about(self, widget, data=None):
        dialog = gtk.AboutDialog()
        dialog.set_name('Weather-Indicator Applet')
        dialog.set_version('0.0.2rev2')
        dialog.set_authors(['Sebastian MacDonald <sebastian.macdonald@gmail.com>', 'Cullen Maglothin <cmaglothin@gmail.com>'])
        dialog.set_comments('A simple weather indicator applet')
        dialog.set_license('Distributed under the GPL license.\nhttp://www.gnu.org/licenses/')
        dialog.run()
        dialog.destroy()

    def hide_dialog(self, widget, data):
        widget.hide()
    
    def firsty(self):
        self.getText()
    
    def replacer(self, widget):
        self.getText()
        
    def adder(self, widget):
        self.getText(replace=False)
            
    def responseToDialog(self, entry, dialog, response):
        dialog.response(response)
        
    def getText(self, replace=True):
        dialog = gtk.MessageDialog(
            None,
            gtk.DIALOG_MODAL | gtk.DIALOG_DESTROY_WITH_PARENT,
            gtk.MESSAGE_QUESTION,
            gtk.BUTTONS_OK,
            None)
        dialog.set_markup('Please enter your address:')
        entry = gtk.Entry()
        entry.connect("activate", self.responseToDialog, dialog, gtk.RESPONSE_OK)
        hbox = gtk.HBox()
        hbox.pack_start(gtk.Label("Address:"), False, 5, 5)
        hbox.pack_end(entry)
        dialog.vbox.pack_end(hbox, True, True, 0)
        dialog.show_all()
        dialog.run()
        if replace == False:
            self.places.append(entry.get_text())
            self.gconfClient.set_string("/apps/weather-indicator/places", str(self.places))
        else:
            self.places = ['']
            self.places[0] = entry.get_text()
            self.gconfClient.set_string("/apps/weather-indicator/places", str(self.places))
        self.gconfClient.set_bool("/apps/weather-indicator/first_run", True)
        dialog.destroy()
        
        self.update_weather()
        
    def get_weather(self, city):
        #create google weather api url
        import locale
        localebad = locale.getlocale()[0]
        locale = localebad.split ('_')
        url = "http://www.google.com/ig/api?weather=" + urllib2.quote(city) + "&hl=" + locale[0]
        print url
        
        try:
            # open google weather api url
            f = urllib2.urlopen(url)

        except:
            # if there was an error opening the url, return
            self.temp = "Connexion Problem"
            self.city = "Connexion Problem"
            self.humid = "Connexion Problem"
            self.wind = "Connexion Problem"
            self.icon = "Connexion Problem"
            return "Error opening url"
        
        s = f.read()
        encoding = f.headers['content-type'].split('charset=')[-1]
        s = unicode(s, encoding).encode('utf-8')
        
        # extract weather condition data from xml string
        weather = s.split("<current_conditions><condition data=\"")[-1].split("\"")[0]
        if self.unit == 'F':
            self.temp = s.split("<temp_f data=\"")[-1].split("\"")[0] + "°F"
        elif self.unit == 'C':
            self.temp = s.split("<temp_c data=\"")[-1].split("\"")[0] + "°C"
        else:
            self.temp = str(int(s.split("<temp_c data=\"")[-1].split("\"")[0])+273) + "°K"
        self.city = s.split("<city data=\"")[-1].split("\"")[0]
        self.humid = s.split("<humidity data=\"")[-1].split("\"")[0]
        self.wind = s.split("<wind_condition data=\"")[-1].split("\"")[0]
        self.icon = s.split("%\"/><icon data=\"/ig/images/weather/")[-1].split(".gif\"")[0]

        # if there was an error getting the condition, the city is invalid
        if weather == "<?xml version=":
            self.temp = "Invalid city"
            self.city = "Invalid city"
            self.humid = "Invalid city"
            self.wind = "Invalid city"
            return "Invalid city"

        #return the weather condition
        return weather
    
    def prefs(self, widget, tab='prefs'):
        window = gtk.Window()
        window.set_size_request(500, 300)
        window.set_title("Weather Indicator")
        
        notery = gtk.Notebook()
        
        vbox_prefs = gtk.VBox(False, 0)
        hupdater = gtk.HBox(False, 0)
        htemp = gtk.HBox(True, 0)
        hwind = gtk.HBox(True, 0)
        
        alerter = gtk.CheckButton("Use notificatoins to give severe weather notifications")
        tipper = gtk.CheckButton("Show tips in menu")
        temp_unit = gtk.Label()
        temp_unit.set_markup("<big><b>Temperature Unit</b></big>")
        temp_unit.set_justify(gtk.JUSTIFY_LEFT)
        wind_unit = gtk.Label()
        wind_unit.set_markup("<big><b>Wind Speed Unit</b></big>")
        wind_unit.set_justify(gtk.JUSTIFY_LEFT)
        update_label = gtk.Label()
        update_label.set_markup("<big><b>Refresh Rate</b></big>")
        location_label = gtk.Label("Locations")
        
        def on_temp_changed(button, data):
            if button.get_active() == True:  
                self.gconfClient.set_string("/apps/weather-indicator/unit", data)
                self.unit = data
                self.update_weather()
                print 'Unit changed :', self.unit  
        
        temp = gtk.RadioButton(group=None, label='Fahrenheit')
        if self.unit == 'F' :
            temp.set_active(True)
        temp.connect("toggled", on_temp_changed, 'F')
        htemp.pack_start(temp, False, False)
        temp.show()
        
        temp = gtk.RadioButton(group=temp, label='Celsius')
        if self.unit == 'C' :
            temp.set_active(True)
        temp.connect("toggled", on_temp_changed, 'C')
        htemp.pack_start(temp, False, False)
        temp.show()
        
        temp = gtk.RadioButton(group=temp, label='Kelvin')
        if self.unit == 'K' :
            temp.set_active(True)
        temp.connect("toggled", on_temp_changed, 'K')
        htemp.pack_start(temp, False, False)
        temp.show()
        
        wind_mph = gtk.RadioButton(group=None, label='mph')
        wind_mps = gtk.RadioButton(group=wind_mph, label='m/s')
        wind_kph = gtk.RadioButton(group=wind_mph, label='km/h')
        wind_knots = gtk.RadioButton(group=wind_mph, label='knots')
        wind_beau = gtk.RadioButton(group=wind_mph, label='Beaufort')
        
        hwind.pack_start(wind_mph, False, False)
        hwind.pack_start(wind_mps, False, False)
        hwind.pack_start(wind_kph, False, False)
        hwind.pack_start(wind_knots, False, False)
        hwind.pack_start(wind_beau, False, False)
        
        def on_update_changed(widget, scroll, value):
            self.update_label.set_text(str(int(value))+' min')
            self.gconfClient.set_int("/apps/weather-indicator/refresh_rate", int(value))
            self.rate = int(value)
            gobject.source_remove(self.rateid)
            self.rateid = gobject.timeout_add(int(self.rate) * 60000, self.update_weather)
            self.rate = int(value)
            print 'Rate changed :',self.rate
       
        update_scale = gtk.HScale()
        update_scale_changed_id = update_scale.connect("change-value", on_update_changed)
        update_scale.set_range(1, 20)
        update_scale.set_increments(1, 10)
        update_scale.set_digits(0)
        update_scale.set_draw_value(False)
        update_scale.set_size_request(300, -1)
        update_scale.set_value(int(self.gconfClient.get_int("/apps/weather-indicator/refresh_rate")))
        self.update_label = gtk.Label(str(int(update_scale.get_value()))+' min')       

        vbox_prefs.pack_start(alerter, False, False)
        vbox_prefs.pack_start(tipper, False, False)
        vbox_prefs.pack_start(temp_unit, False, False)
        vbox_prefs.pack_start(htemp, False, False)
        vbox_prefs.pack_start(wind_unit, False, False)
        vbox_prefs.pack_start(hwind, False, False)
        vbox_prefs.pack_start(hupdater, False, False)
        
        hupdater.pack_start(update_label, False, False)
        hupdater.pack_start(update_scale, False, False)
        hupdater.pack_start(self.update_label, False, False)

        vbox_extforecast=gtk.VBox(False, 0)
        
        notery.append_page(vbox_prefs, tab_label=gtk.Label('Preferences'))
        notery.append_page(vbox_extforecast, tab_label=gtk.Label('Extended Forecast'))
        
        window.add(notery)
        
        window.show_all()
    
def main():
    gtk.main()
    return 0

if __name__ == "__main__":
    indicator = weather_indicator()
    main()
